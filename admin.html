<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  
  <title>Admin Panel | MVP Launches</title>
  
  <link rel="icon" type="image/png" href="assets/logo-mvp.png">
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/global.css">
  
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      background-color: var(--color-gray-50);
      min-height: 100vh;
    }
    
    /* Auth gate */
    .auth-gate {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-6);
    }
    
    .auth-gate__box {
      background: white;
      padding: var(--space-10);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      max-width: 400px;
      width: 100%;
      text-align: center;
    }
    
    .auth-gate__logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-3);
      margin-bottom: var(--space-6);
    }
    
    .auth-gate__logo img {
      height: 50px;
    }
    
    .auth-gate__logo span {
      font-family: var(--font-display);
      font-size: var(--text-2xl);
      font-weight: var(--font-semibold);
      color: var(--color-gray-700);
    }
    
    .auth-gate__title {
      font-size: var(--text-xl);
      margin-bottom: var(--space-6);
      color: var(--color-gray-600);
    }
    
    .auth-gate__form {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }
    
    .auth-gate__input {
      padding: var(--space-4);
      border: 2px solid var(--color-gray-100);
      border-radius: var(--radius-md);
      font-size: var(--text-base);
    }
    
    .auth-gate__input:focus {
      outline: none;
      border-color: var(--color-accent);
    }
    
    .auth-gate__error {
      color: #e53e3e;
      font-size: var(--text-sm);
      display: none;
    }
    
    .auth-gate__error.visible {
      display: block;
    }
    
    /* Admin layout */
    .admin {
      display: none;
    }
    
    .admin.visible {
      display: block;
    }
    
    .admin__header {
      background: white;
      border-bottom: 1px solid var(--color-gray-100);
      padding: var(--space-4) var(--space-6);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .admin__header-inner {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .admin__logo {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    
    .admin__logo img {
      height: 40px;
    }
    
    .admin__logo span {
      font-family: var(--font-display);
      font-size: var(--text-xl);
      font-weight: var(--font-semibold);
      color: var(--color-gray-700);
    }
    
    .admin__logo em {
      font-style: normal;
      color: var(--color-accent);
    }
    
    .admin__user {
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }
    
    .admin__user-email {
      color: var(--color-gray-500);
      font-size: var(--text-sm);
    }
    
    .admin__logout {
      padding: var(--space-2) var(--space-4);
      background: var(--color-gray-100);
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: var(--text-sm);
      color: var(--color-gray-600);
      transition: all var(--transition-fast);
    }
    
    .admin__logout:hover {
      background: var(--color-gray-200);
    }
    
    /* Tabs */
    .admin__tabs {
      background: white;
      border-bottom: 1px solid var(--color-gray-100);
    }
    
    .admin__tabs-inner {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      gap: var(--space-1);
      padding: 0 var(--space-6);
    }
    
    .admin__tab {
      padding: var(--space-4) var(--space-6);
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: var(--text-base);
      font-weight: var(--font-medium);
      color: var(--color-gray-500);
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    
    .admin__tab:hover {
      color: var(--color-gray-700);
    }
    
    .admin__tab.active {
      color: var(--color-accent);
      border-bottom-color: var(--color-accent);
    }
    
    .admin__tab-count {
      background: var(--color-gray-100);
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
    }
    
    .admin__tab.active .admin__tab-count {
      background: var(--color-accent-light);
      color: var(--color-accent);
    }
    
    /* Content */
    .admin__content {
      max-width: 1400px;
      margin: 0 auto;
      padding: var(--space-6);
    }
    
    .admin__panel {
      display: none;
    }
    
    .admin__panel.active {
      display: block;
    }
    
    /* Filters */
    .filters {
      display: flex;
      gap: var(--space-4);
      margin-bottom: var(--space-6);
      flex-wrap: wrap;
      align-items: center;
    }
    
    .filters__label {
      font-weight: var(--font-medium);
      color: var(--color-gray-600);
    }
    
    .filters__select {
      padding: var(--space-2) var(--space-4);
      border: 2px solid var(--color-gray-100);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      background: white;
      cursor: pointer;
    }
    
    .filters__select:focus {
      outline: none;
      border-color: var(--color-accent);
    }
    
    .filters__refresh {
      padding: var(--space-2) var(--space-4);
      background: var(--color-gray-100);
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--text-sm);
      color: var(--color-gray-600);
      margin-left: auto;
    }
    
    .filters__refresh:hover {
      background: var(--color-gray-200);
    }
    
    /* Cards */
    .cards {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }
    
    .card {
      background: white;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      transition: all var(--transition-fast);
    }
    
    .card:hover {
      box-shadow: var(--shadow-md);
    }
    
    .card__header {
      padding: var(--space-5) var(--space-6);
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--color-gray-50);
      cursor: pointer;
    }
    
    .card__header:hover {
      background: var(--color-gray-50);
    }
    
    .card__main {
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }
    
    .card__icon {
      width: 48px;
      height: 48px;
      background: var(--color-accent-light);
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .card__icon svg {
      width: 24px;
      height: 24px;
      color: var(--color-accent);
    }
    
    .card__icon--warning {
      background: #fef3c7;
    }
    
    .card__icon--warning svg {
      color: #d97706;
    }
    
    .card__icon--success {
      background: #d1fae5;
    }
    
    .card__icon--success svg {
      color: #059669;
    }
    
    .card__icon--muted {
      background: var(--color-gray-100);
    }
    
    .card__icon--muted svg {
      color: var(--color-gray-400);
    }
    
    .card__info {
      flex: 1;
    }
    
    .card__name {
      font-weight: var(--font-semibold);
      color: var(--color-gray-800);
      margin-bottom: 2px;
    }
    
    .card__meta {
      font-size: var(--text-sm);
      color: var(--color-gray-500);
      display: flex;
      gap: var(--space-3);
      flex-wrap: wrap;
    }
    
    .card__meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .card__scores {
      display: flex;
      gap: var(--space-4);
      align-items: center;
    }
    
    .card__score {
      text-align: center;
    }
    
    .card__score-value {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      line-height: 1;
    }
    
    .card__score-value--auto {
      color: var(--color-gray-400);
    }
    
    .card__score-value--human {
      color: var(--color-accent);
    }
    
    .card__score-value--final {
      color: var(--color-gray-800);
    }
    
    .card__score-value--pending {
      color: var(--color-gray-300);
    }
    
    .card__score-label {
      font-size: var(--text-xs);
      color: var(--color-gray-400);
      text-transform: uppercase;
    }
    
    .card__toggle {
      color: var(--color-gray-300);
      transition: transform var(--transition-fast);
    }
    
    .card.expanded .card__toggle {
      transform: rotate(180deg);
    }
    
    /* Card body */
    .card__body {
      display: none;
      padding: var(--space-6);
      background: var(--color-gray-50);
      border-top: 1px solid var(--color-gray-100);
    }
    
    .card.expanded .card__body {
      display: block;
    }
    
    .card__grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }
    
    .card__field {
      background: white;
      padding: var(--space-4);
      border-radius: var(--radius-md);
    }
    
    .card__field-label {
      font-size: var(--text-xs);
      color: var(--color-gray-400);
      text-transform: uppercase;
      margin-bottom: var(--space-1);
    }
    
    .card__field-value {
      color: var(--color-gray-700);
      word-break: break-word;
    }
    
    .card__field-value a {
      color: var(--color-accent);
    }
    
    /* Challenge section */
    .card__challenge {
      background: white;
      padding: var(--space-5);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-6);
      border-left: 4px solid var(--color-accent);
    }
    
    .card__challenge-label {
      font-size: var(--text-xs);
      color: var(--color-gray-400);
      text-transform: uppercase;
      margin-bottom: var(--space-2);
    }
    
    .card__challenge-question {
      font-weight: var(--font-medium);
      color: var(--color-gray-700);
      margin-bottom: var(--space-4);
    }
    
    .card__challenge-answer {
      color: var(--color-gray-600);
      line-height: 1.6;
      padding: var(--space-4);
      background: var(--color-gray-50);
      border-radius: var(--radius-md);
    }
    
    .card__challenge-skipped {
      color: var(--color-gray-400);
      font-style: italic;
    }
    
    /* Scoring form */
    .card__scoring {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-4);
      background: white;
      border-radius: var(--radius-lg);
    }
    
    .card__scoring-label {
      font-weight: var(--font-medium);
      color: var(--color-gray-700);
    }
    
    .card__scoring-input {
      width: 80px;
      padding: var(--space-2) var(--space-3);
      border: 2px solid var(--color-gray-200);
      border-radius: var(--radius-md);
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      text-align: center;
    }
    
    .card__scoring-input:focus {
      outline: none;
      border-color: var(--color-accent);
    }
    
    .card__scoring-hint {
      font-size: var(--text-sm);
      color: var(--color-gray-400);
    }
    
    .card__scoring-btn {
      padding: var(--space-2) var(--space-4);
      background: var(--color-accent);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-weight: var(--font-medium);
      transition: all var(--transition-fast);
    }
    
    .card__scoring-btn:hover {
      background: var(--color-accent-dark);
    }
    
    .card__scoring-btn:disabled {
      background: var(--color-gray-200);
      cursor: not-allowed;
    }
    
    .card__scoring-saved {
      color: #059669;
      font-size: var(--text-sm);
      display: none;
    }
    
    .card__scoring-saved.visible {
      display: block;
    }
    
    /* Status badge */
    .status-badge {
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-medium);
      text-transform: uppercase;
    }
    
    .status-badge--pending {
      background: #fef3c7;
      color: #d97706;
    }
    
    .status-badge--reviewed {
      background: #d1fae5;
      color: #059669;
    }
    
    .status-badge--skipped {
      background: var(--color-gray-100);
      color: var(--color-gray-500);
    }
    
    /* Empty state */
    .empty-state {
      text-align: center;
      padding: var(--space-16);
      color: var(--color-gray-400);
    }
    
    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: var(--space-4);
      opacity: 0.5;
    }
    
    /* Stats grid for Observatorio */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-4);
      margin-bottom: var(--space-8);
    }
    
    .stat-card {
      background: white;
      padding: var(--space-6);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-sm);
    }
    
    .stat-card__value {
      font-size: var(--text-4xl);
      font-weight: var(--font-bold);
      color: var(--color-gray-800);
      line-height: 1;
      margin-bottom: var(--space-2);
    }
    
    .stat-card__label {
      color: var(--color-gray-500);
      font-size: var(--text-sm);
    }
    
    .stat-card--accent .stat-card__value {
      color: var(--color-accent);
    }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: var(--space-10);
      color: var(--color-gray-400);
    }
    
    .loading__spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--color-gray-100);
      border-top-color: var(--color-accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto var(--space-4);
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .admin__tabs-inner {
        overflow-x: auto;
        padding-bottom: var(--space-2);
      }
      
      .card__scores {
        flex-direction: column;
        gap: var(--space-2);
      }
      
      .card__header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-4);
      }
      
      .card__scoring {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .filters {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>

  <!-- Auth Gate -->
  <div class="auth-gate" id="authGate">
    <div class="auth-gate__box">
      <div class="auth-gate__logo">
        <img src="assets/logo-mvp.png" alt="MVP Launches">
        <span>Admin</span>
      </div>
      <h1 class="auth-gate__title">Acceso restringido</h1>
      <form class="auth-gate__form" id="loginForm">
        <input type="email" class="auth-gate__input" id="loginEmail" placeholder="Email" required>
        <input type="password" class="auth-gate__input" id="loginPassword" placeholder="Contraseña" required>
        <p class="auth-gate__error" id="loginError">Email o contraseña incorrectos</p>
        <button type="submit" class="btn btn--primary">Entrar</button>
      </form>
    </div>
  </div>

  <!-- Admin Panel -->
  <div class="admin" id="adminPanel">
    
    <!-- Header -->
    <header class="admin__header">
      <div class="admin__header-inner">
        <div class="admin__logo">
          <img src="assets/logo-mvp.png" alt="MVP Launches">
          <span>mvp<em>launches</em> Admin</span>
        </div>
        <div class="admin__user">
          <span class="admin__user-email" id="userEmail"></span>
          <button class="admin__logout" id="logoutBtn">Cerrar sesión</button>
        </div>
      </div>
    </header>
    
    <!-- Tabs -->
    <nav class="admin__tabs">
      <div class="admin__tabs-inner">
        <button class="admin__tab active" data-tab="chispas">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
          </svg>
          Chispas
          <span class="admin__tab-count" id="chispasCount">0</span>
        </button>
        <button class="admin__tab" data-tab="tasaciones">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
          </svg>
          Tasaciones
          <span class="admin__tab-count" id="tasacionesCount">0</span>
        </button>
        <button class="admin__tab" data-tab="observatorio">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="20" x2="18" y2="10"/>
            <line x1="12" y1="20" x2="12" y2="4"/>
            <line x1="6" y1="20" x2="6" y2="14"/>
          </svg>
          Observatorio
        </button>
      </div>
    </nav>
    
    <!-- Content -->
    <main class="admin__content">
      
      <!-- Panel: Chispas -->
      <section class="admin__panel active" id="panel-chispas">
        <div class="filters">
          <span class="filters__label">Filtrar:</span>
          <select class="filters__select" id="filterStatus">
            <option value="all">Todos los estados</option>
            <option value="pending_review">Pendientes de revisar</option>
            <option value="reviewed">Revisados</option>
            <option value="skipped_challenge">Saltaron desafío</option>
          </select>
          <select class="filters__select" id="filterSkill">
            <option value="all">Todas las skills</option>
            <option value="comercial">Comercial</option>
            <option value="marketing">Marketing</option>
            <option value="operaciones">Operaciones</option>
            <option value="financiero">Financiero</option>
            <option value="producto">Producto</option>
            <option value="sector">Experto sector</option>
          </select>
          <select class="filters__select" id="filterScore">
            <option value="all">Cualquier score</option>
            <option value="high">Score > 6</option>
            <option value="medium">Score 4-6</option>
            <option value="low">Score < 4</option>
          </select>
          <button class="filters__refresh" id="refreshChispas">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M23 4v6h-6"/>
              <path d="M1 20v-6h6"/>
              <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
            </svg>
            Actualizar
          </button>
        </div>
        
        <div class="cards" id="chispasContainer">
          <div class="loading">
            <div class="loading__spinner"></div>
            Cargando...
          </div>
        </div>
      </section>
      
      <!-- Panel: Tasaciones -->
      <section class="admin__panel" id="panel-tasaciones">
        <div class="filters">
          <span class="filters__label">Filtrar:</span>
          <select class="filters__select" id="filterTasacionStatus">
            <option value="all">Todos</option>
            <option value="pending">Pendientes</option>
            <option value="contacted">Contactados</option>
          </select>
          <button class="filters__refresh" id="refreshTasaciones">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M23 4v6h-6"/>
              <path d="M1 20v-6h6"/>
              <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
            </svg>
            Actualizar
          </button>
        </div>
        
        <div class="cards" id="tasacionesContainer">
          <div class="loading">
            <div class="loading__spinner"></div>
            Cargando...
          </div>
        </div>
      </section>
      
      <!-- Panel: Observatorio -->
      <section class="admin__panel" id="panel-observatorio">
        <div class="stats-grid" id="statsGrid">
          <!-- Se llena dinámicamente -->
        </div>
        
        <h3 style="margin-bottom: var(--space-4);">Distribución por skill</h3>
        <div class="cards" id="skillsDistribution">
          <!-- Se llena dinámicamente -->
        </div>
      </section>
      
    </main>
  </div>

  <!-- Scripts -->
  <script type="module">
    import { auth, db } from './js/firebase-config.js';
    import { 
      signInWithEmailAndPassword, 
      onAuthStateChanged, 
      signOut 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
      collection, 
      query, 
      orderBy, 
      getDocs, 
      doc, 
      updateDoc,
      where,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    // ========================================
    // ADMIN EMAILS (quién puede acceder)
    // ========================================
    const ADMIN_EMAILS = [
      'felipe@fgq98.com',
      'admin@mvplaunches.com'
      // Añade aquí más emails de admins
    ];
    
    // ========================================
    // DOM ELEMENTS
    // ========================================
    const authGate = document.getElementById('authGate');
    const adminPanel = document.getElementById('adminPanel');
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('loginError');
    const userEmailSpan = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');
    
    // ========================================
    // AUTH HANDLING
    // ========================================
    onAuthStateChanged(auth, (user) => {
      if (user && ADMIN_EMAILS.includes(user.email)) {
        authGate.style.display = 'none';
        adminPanel.classList.add('visible');
        userEmailSpan.textContent = user.email;
        loadAllData();
      } else {
        authGate.style.display = 'flex';
        adminPanel.classList.remove('visible');
        if (user) {
          // Usuario logueado pero no es admin
          signOut(auth);
          loginError.textContent = 'No tienes permisos de administrador';
          loginError.classList.add('visible');
        }
      }
    });
    
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      try {
        await signInWithEmailAndPassword(auth, email, password);
        loginError.classList.remove('visible');
      } catch (error) {
        loginError.textContent = 'Email o contraseña incorrectos';
        loginError.classList.add('visible');
      }
    });
    
    logoutBtn.addEventListener('click', () => signOut(auth));
    
    // ========================================
    // TABS
    // ========================================
    document.querySelectorAll('.admin__tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.admin__tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.admin__panel').forEach(p => p.classList.remove('active'));
        
        tab.classList.add('active');
        document.getElementById(`panel-${tab.dataset.tab}`).classList.add('active');
      });
    });
    
    // ========================================
    // LOAD DATA
    // ========================================
    let chispasData = [];
    let tasacionesData = [];
    
    async function loadAllData() {
      await Promise.all([
        loadChispas(),
        loadTasaciones()
      ]);
      updateObservatorio();
    }
    
    async function loadChispas() {
      const container = document.getElementById('chispasContainer');
      container.innerHTML = '<div class="loading"><div class="loading__spinner"></div>Cargando...</div>';
      
      try {
        const q = query(collection(db, "chispas"), orderBy("created_at", "desc"));
        const snapshot = await getDocs(q);
        
        chispasData = [];
        snapshot.forEach(doc => {
          chispasData.push({ id: doc.id, ...doc.data() });
        });
        
        document.getElementById('chispasCount').textContent = chispasData.length;
        renderChispas();
        
      } catch (error) {
        console.error('Error loading chispas:', error);
        container.innerHTML = '<div class="empty-state">Error al cargar datos</div>';
      }
    }
    
    async function loadTasaciones() {
      const container = document.getElementById('tasacionesContainer');
      container.innerHTML = '<div class="loading"><div class="loading__spinner"></div>Cargando...</div>';
      
      try {
        const q = query(collection(db, "tasaciones"), orderBy("created_at", "desc"));
        const snapshot = await getDocs(q);
        
        tasacionesData = [];
        snapshot.forEach(doc => {
          tasacionesData.push({ id: doc.id, ...doc.data() });
        });
        
        document.getElementById('tasacionesCount').textContent = tasacionesData.length;
        renderTasaciones();
        
      } catch (error) {
        console.error('Error loading tasaciones:', error);
        container.innerHTML = '<div class="empty-state">Error al cargar datos</div>';
      }
    }
    
    // ========================================
    // RENDER CHISPAS
    // ========================================
    function renderChispas() {
      const container = document.getElementById('chispasContainer');
      const statusFilter = document.getElementById('filterStatus').value;
      const skillFilter = document.getElementById('filterSkill').value;
      const scoreFilter = document.getElementById('filterScore').value;
      
      let filtered = chispasData.filter(c => {
        if (statusFilter !== 'all' && c.status !== statusFilter) return false;
        if (skillFilter !== 'all' && c.skill_principal !== skillFilter) return false;
        if (scoreFilter === 'high' && (c.score_auto || 0) <= 6) return false;
        if (scoreFilter === 'medium' && ((c.score_auto || 0) < 4 || (c.score_auto || 0) > 6)) return false;
        if (scoreFilter === 'low' && (c.score_auto || 0) >= 4) return false;
        return true;
      });
      
      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M8 15h8"/>
              <circle cx="9" cy="9" r="1"/>
              <circle cx="15" cy="9" r="1"/>
            </svg>
            <p>No hay chispas con estos filtros</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = filtered.map(c => renderChispaCard(c)).join('');
      
      // Add event listeners
      container.querySelectorAll('.card__header').forEach(header => {
        header.addEventListener('click', () => {
          header.closest('.card').classList.toggle('expanded');
        });
      });
      
      container.querySelectorAll('.card__scoring-btn').forEach(btn => {
        btn.addEventListener('click', handleScoring);
      });
    }
    
    function renderChispaCard(c) {
      const scoreAuto = c.score_auto !== null ? c.score_auto.toFixed(1) : '-';
      const scoreHumano = c.score_humano !== null ? c.score_humano.toFixed(1) : '-';
      const scoreFinal = c.score_final !== null ? c.score_final.toFixed(1) : '-';
      
      const statusClass = c.status === 'reviewed' ? 'success' : 
                          c.status === 'skipped_challenge' ? 'muted' : 'warning';
      const statusText = c.status === 'reviewed' ? 'Revisado' :
                         c.status === 'skipped_challenge' ? 'Saltó desafío' : 'Pendiente';
      
      const skills = Array.isArray(c.tipo_chispa) ? c.tipo_chispa.join(', ') : c.tipo_chispa || '-';
      
      const createdAt = c.created_at?.toDate?.() 
        ? c.created_at.toDate().toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' })
        : '-';
      
      return `
        <div class="card" data-id="${c.id}">
          <div class="card__header">
            <div class="card__main">
              <div class="card__icon card__icon--${statusClass}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                </svg>
              </div>
              <div class="card__info">
                <p class="card__name">${c.nombre || ''} ${c.apellidos || ''}</p>
                <div class="card__meta">
                  <span>${skills}</span>
                  <span>•</span>
                  <span>${c.dedicacion || '-'}</span>
                  <span>•</span>
                  <span>${createdAt}</span>
                </div>
              </div>
            </div>
            <div class="card__scores">
              <div class="card__score">
                <p class="card__score-value card__score-value--auto">${scoreAuto}</p>
                <p class="card__score-label">Auto</p>
              </div>
              <div class="card__score">
                <p class="card__score-value ${c.score_humano !== null ? 'card__score-value--human' : 'card__score-value--pending'}">${scoreHumano}</p>
                <p class="card__score-label">Humano</p>
              </div>
              <div class="card__score">
                <p class="card__score-value ${c.score_final !== null ? 'card__score-value--final' : 'card__score-value--pending'}">${scoreFinal}</p>
                <p class="card__score-label">Final</p>
              </div>
              <span class="status-badge status-badge--${c.status === 'reviewed' ? 'reviewed' : c.status === 'skipped_challenge' ? 'skipped' : 'pending'}">${statusText}</span>
              <svg class="card__toggle" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"/>
              </svg>
            </div>
          </div>
          <div class="card__body">
            <div class="card__grid">
              <div class="card__field">
                <p class="card__field-label">Email</p>
                <p class="card__field-value"><a href="mailto:${c.email}">${c.email || '-'}</a></p>
              </div>
              <div class="card__field">
                <p class="card__field-label">LinkedIn</p>
                <p class="card__field-value">${c.linkedin ? `<a href="${c.linkedin}" target="_blank">Ver perfil →</a>` : '-'}</p>
              </div>
              <div class="card__field">
                <p class="card__field-label">Dedicación</p>
                <p class="card__field-value">${c.dedicacion || '-'}</p>
              </div>
              <div class="card__field">
                <p class="card__field-label">Inversión</p>
                <p class="card__field-value">${c.inversion || '-'}</p>
              </div>
              <div class="card__field">
                <p class="card__field-label">Sector específico</p>
                <p class="card__field-value">${c.sector_especifico || '-'}</p>
              </div>
            </div>
            
            <div class="card__field" style="margin-bottom: var(--space-6);">
              <p class="card__field-label">Motivación</p>
              <p class="card__field-value">${c.motivacion || '-'}</p>
            </div>
            
            ${c.desafio_pregunta ? `
            <div class="card__challenge">
              <p class="card__challenge-label">Desafío (${c.desafio_skill || '-'})</p>
              <p class="card__challenge-question">${c.desafio_pregunta}</p>
              ${c.respuesta_desafio === '[SKIPPED]' 
                ? '<p class="card__challenge-skipped">El candidato decidió no responder</p>'
                : `<div class="card__challenge-answer">${c.respuesta_desafio || '-'}</div>`
              }
            </div>
            ` : ''}
            
            <div class="card__scoring">
              <span class="card__scoring-label">Tu puntuación:</span>
              <input type="number" class="card__scoring-input" min="0" max="10" step="0.5" value="${c.score_humano || ''}" placeholder="0-10">
              <span class="card__scoring-hint">(0-10)</span>
              <button class="card__scoring-btn" data-id="${c.id}">Guardar</button>
              <span class="card__scoring-saved">✓ Guardado</span>
            </div>
          </div>
        </div>
      `;
    }
    
    async function handleScoring(e) {
      const btn = e.target;
      const card = btn.closest('.card');
      const id = btn.dataset.id;
      const input = card.querySelector('.card__scoring-input');
      const savedMsg = card.querySelector('.card__scoring-saved');
      const scoreHumano = parseFloat(input.value);
      
      if (isNaN(scoreHumano) || scoreHumano < 0 || scoreHumano > 10) {
        alert('Introduce un valor entre 0 y 10');
        return;
      }
      
      btn.disabled = true;
      btn.textContent = 'Guardando...';
      
      try {
        // Get current data
        const chispa = chispasData.find(c => c.id === id);
        const scoreAuto = chispa?.score_auto || 0;
        const scoreFinal = (scoreAuto + scoreHumano) / 2;
        
        await updateDoc(doc(db, "chispas", id), {
          score_humano: scoreHumano,
          score_final: Math.round(scoreFinal * 10) / 10,
          status: 'reviewed'
        });
        
        // Update local data
        const idx = chispasData.findIndex(c => c.id === id);
        if (idx !== -1) {
          chispasData[idx].score_humano = scoreHumano;
          chispasData[idx].score_final = Math.round(scoreFinal * 10) / 10;
          chispasData[idx].status = 'reviewed';
        }
        
        btn.textContent = 'Guardar';
        btn.disabled = false;
        savedMsg.classList.add('visible');
        setTimeout(() => savedMsg.classList.remove('visible'), 2000);
        
        // Re-render to update scores display
        renderChispas();
        
      } catch (error) {
        console.error('Error saving score:', error);
        alert('Error al guardar. Inténtalo de nuevo.');
        btn.textContent = 'Guardar';
        btn.disabled = false;
      }
    }
    
    // ========================================
    // RENDER TASACIONES
    // ========================================
    function renderTasaciones() {
      const container = document.getElementById('tasacionesContainer');
      
      if (tasacionesData.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
            </svg>
            <p>No hay tasaciones todavía</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = tasacionesData.map(t => {
        const createdAt = t.created_at?.toDate?.()
          ? t.created_at.toDate().toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' })
          : '-';
        
        return `
          <div class="card">
            <div class="card__header">
              <div class="card__main">
                <div class="card__icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                  </svg>
                </div>
                <div class="card__info">
                  <p class="card__name">${t.nombre_proyecto || 'Sin nombre'}</p>
                  <div class="card__meta">
                    <span>${t.email || '-'}</span>
                    <span>•</span>
                    <span>${createdAt}</span>
                  </div>
                </div>
              </div>
              <div class="card__scores">
                <div class="card__score">
                  <p class="card__score-value card__score-value--final">${t.valoracion_total ? '€' + t.valoracion_total.toLocaleString() : '-'}</p>
                  <p class="card__score-label">Valoración</p>
                </div>
                <svg class="card__toggle" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6 9 12 15 18 9"/>
                </svg>
              </div>
            </div>
            <div class="card__body">
              <div class="card__grid">
                <div class="card__field">
                  <p class="card__field-label">Email</p>
                  <p class="card__field-value"><a href="mailto:${t.email}">${t.email || '-'}</a></p>
                </div>
                <div class="card__field">
                  <p class="card__field-label">Estado</p>
                  <p class="card__field-value">${t.estado_mvp || '-'}</p>
                </div>
                <div class="card__field">
                  <p class="card__field-label">Tipo producto</p>
                  <p class="card__field-value">${t.tipo_producto || '-'}</p>
                </div>
                <div class="card__field">
                  <p class="card__field-label">Plazo desarrollo</p>
                  <p class="card__field-value">${t.plazo_desarrollo || '-'}</p>
                </div>
              </div>
              <div class="card__field">
                <p class="card__field-label">Descripción</p>
                <p class="card__field-value">${t.descripcion || '-'}</p>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      container.querySelectorAll('.card__header').forEach(header => {
        header.addEventListener('click', () => {
          header.closest('.card').classList.toggle('expanded');
        });
      });
    }
    
    // ========================================
    // OBSERVATORIO
    // ========================================
    function updateObservatorio() {
      const statsGrid = document.getElementById('statsGrid');
      const skillsContainer = document.getElementById('skillsDistribution');
      
      // Calcular stats
      const totalChispas = chispasData.length;
      const totalTasaciones = tasacionesData.length;
      const pendingReview = chispasData.filter(c => c.status === 'pending_review').length;
      const avgScore = chispasData.filter(c => c.score_final).reduce((acc, c) => acc + c.score_final, 0) / 
                       (chispasData.filter(c => c.score_final).length || 1);
      const highPotential = chispasData.filter(c => (c.score_auto || 0) > 6).length;
      
      statsGrid.innerHTML = `
        <div class="stat-card">
          <p class="stat-card__value">${totalChispas}</p>
          <p class="stat-card__label">Total chispas</p>
        </div>
        <div class="stat-card">
          <p class="stat-card__value">${totalTasaciones}</p>
          <p class="stat-card__label">Total tasaciones</p>
        </div>
        <div class="stat-card stat-card--accent">
          <p class="stat-card__value">${pendingReview}</p>
          <p class="stat-card__label">Pendientes de revisar</p>
        </div>
        <div class="stat-card">
          <p class="stat-card__value">${avgScore.toFixed(1)}</p>
          <p class="stat-card__label">Score promedio</p>
        </div>
        <div class="stat-card stat-card--accent">
          <p class="stat-card__value">${highPotential}</p>
          <p class="stat-card__label">Alto potencial (>6)</p>
        </div>
      `;
      
      // Distribución por skill
      const skillCounts = {};
      chispasData.forEach(c => {
        const skill = c.skill_principal || 'sin definir';
        skillCounts[skill] = (skillCounts[skill] || 0) + 1;
      });
      
      const sortedSkills = Object.entries(skillCounts).sort((a, b) => b[1] - a[1]);
      
      if (sortedSkills.length === 0) {
        skillsContainer.innerHTML = '<div class="empty-state"><p>Sin datos todavía</p></div>';
      } else {
        skillsContainer.innerHTML = sortedSkills.map(([skill, count]) => `
          <div class="card" style="padding: var(--space-4) var(--space-6);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="font-weight: var(--font-medium); text-transform: capitalize;">${skill}</span>
              <span style="font-size: var(--text-2xl); font-weight: var(--font-bold); color: var(--color-accent);">${count}</span>
            </div>
          </div>
        `).join('');
      }
    }
    
    // ========================================
    // FILTERS
    // ========================================
    document.getElementById('filterStatus').addEventListener('change', renderChispas);
    document.getElementById('filterSkill').addEventListener('change', renderChispas);
    document.getElementById('filterScore').addEventListener('change', renderChispas);
    document.getElementById('refreshChispas').addEventListener('click', loadChispas);
    document.getElementById('refreshTasaciones').addEventListener('click', loadTasaciones);
    
  </script>

</body>
</html>
